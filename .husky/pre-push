#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "üîç Running pre-push checks..."

# Run type checking
echo "üìù Type checking..."
pnpm run typecheck || {
  echo "‚ùå Type check failed! Please fix TypeScript errors before pushing."
  exit 1
}

# Run tests and capture exit code separately
echo "üß™ Running tests..."
pnpm test > /tmp/test-output.txt 2>&1
TEST_EXIT_CODE=$?
cat /tmp/test-output.txt

# Check if tests passed (exit code 0) or extract pass rate
if [ $TEST_EXIT_CODE -eq 0 ]; then
  echo "‚úÖ All tests passed!"
else
  # Extract test results from output (handle binary data)
  PASSED=$(grep -a -oE '[0-9]+ passed' /tmp/test-output.txt | grep -oE '[0-9]+' | tail -1)
  FAILED=$(grep -a -oE '[0-9]+ failed' /tmp/test-output.txt | grep -oE '[0-9]+' | tail -1)
  
  if [ -n "$PASSED" ] && [ -n "$FAILED" ]; then
    TOTAL=$((PASSED + FAILED))
    PASS_RATE=$((PASSED * 100 / TOTAL))
    
    echo "üìä Test results: $PASSED/$TOTAL passed ($PASS_RATE%)"
    
    if [ $PASS_RATE -ge 80 ]; then
      echo "‚úÖ Tests pass with $PASS_RATE% success rate (‚â•80% required)"
    else
      echo "‚ùå Tests failed! Only $PASS_RATE% passed (80% required)"
      echo "   Please fix failing tests before pushing."
      exit 1
    fi
  else
    echo "‚ö†Ô∏è  Could not determine test pass rate. Allowing push."
  fi
fi

echo "‚úÖ Pre-push checks completed successfully!"